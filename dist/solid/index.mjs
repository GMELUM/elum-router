import{atom as t,getter as e,setter as o,globalSignal as r}from"elum-state/solid";import a from"@vkontakte/vk-bridge";import{createStore as n}from"solid-js/store";import{onMount as p}from"solid-js";const s=(t,e,o=[])=>{if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e){if(t.constructor!==e.constructor)return!1;var r,a,n;if(Array.isArray(t)){if((r=t.length)!=e.length)return!1;for(a=r;0!=a--;)if(!s(t[a],e[a]))return!1;return!0}if(t.constructor===RegExp)return t.source===e.source&&t.flags===e.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===e.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===e.toString();if((r=(n=Object.keys(t)).length)!==Object.keys(e).length)return!1;for(a=r;0!=a--;){var p=n[a];if(!o.includes(p)){if(!Object.prototype.hasOwnProperty.call(e,p))return!1;if(!s(t[p],e[p]))return!1}}return!0}return t!=t&&e!=e},i={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},l={},c=t({key:"router_active_app"}),u=t({key:"router_active_view"}),f=t({key:"router_active_panel"}),y=t({key:"router_active_modal"}),m=t({key:"router_active_popout"}),d=t({key:"router_active_notify"}),v=t({key:"router_active_params"}),_=t({key:"router_active_callback"}),h=["popout","modal","panel"],w=(t,r)=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=e(c),n=t.view||e(u);l[a]||(l[a]={__snapshot:[]}),l[a][n]||(l[a][n]=[i]);const p=l[a][n].length,d=l[a][n][p-1],w={view:n,panel:t.panel||d.panel,modal:t.modal||d.modal,popout:t.popout||d.popout,stay:t.stay||i.stay,freeze:t.freeze||i.freeze,params:t.params||d.params,callback:r||void 0};for(let e of h){if(t[e])break;w[e]=i[e]}s(d,w)||l[a][n].push(w),l[a].__snapshot=[w],o(c,a),o(u,n),o(f,w.panel),o(y,w.modal),o(m,w.popout),o(v,w.params),o(_,w.callback),t.clear&&n!=n&&(l[a].__snapshot=[i],l[a][n]=[i])},b=(t={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const r=e(c),n=e(u),p=l[r][n],s=((t,e)=>{const o=typeof t;if("boolean"===o&&!t)return e.length-2;const r="boolean"===o?Boolean:String;for(let o=e.length-1;o>0;o--)if(r(e[o].stay)===t)return o;return 0})(t.toStay||!1,p);if(1===p.length)return void a.send("VKWebAppClose",{status:"success"});const i=p.at(-1);i&&i.freeze&&!t.ignoreFreeze||(l[r].__snapshot=[{view:n,...p[s]}],o(c,r),o(u,n),o(f,p[s].panel),o(y,p[s].modal),o(m,p[s].popout),o(v,p[s].params),p.splice(s+1))},k=(t,e)=>{l[t]||(l[t]={__snapshot:[Object.assign(i,e)]});const r=l[t].__snapshot[0];o(c,t),o(u,r.view||e.view),o(f,r.panel||e.panel),o(y,r.modal||e.modal),o(m,r.popout||e.popout),o(v,r.params||e.params)},g=t=>{const o=e(_);o&&"function"==typeof o?o(t):console.warn("There is no function for callback")};function O(t,e,r,a){return a?function(t,e,r,a){const n=()=>(o(d,void 0),a);o(d,{type:t,params:r,callback:n}),e&&setTimeout((()=>{n()({type:t,params:r})}),e)}(t,e,r,a):function(t,e,r){return new Promise((a=>{const n=()=>(o(d,void 0),a);o(d,{type:t,params:r,callback:n}),e&&setTimeout((()=>{n()({type:t,params:r})}),e)}))}(t,e,r)}function j(t){try{const r=e(d);return(!t||r.type===t)&&(o(d,void 0),r.callback({type:r.type,params:r.params}),!0)}catch{return!1}}const S=()=>{const[t]=n(e(v));return t},z={view:u,panel:f,modal:y,popout:m},A=t=>{const[e]=r(z[t]);return e},T=()=>{const[t]=r(d),e=t();return e?{type:e.type,params:e.params}:{type:void 0,params:{}}},x=t=>(e(c)&&e(u)||k(t.app||"app",{view:t.branch}),p((()=>{window.addEventListener("popstate",(()=>b())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")})),t.children);export{c as ACTIVE_APP,y as ACTIVE_MODAL,d as ACTIVE_NOTIFY,f as ACTIVE_PANEL,v as ACTIVE_PARAMS,m as ACTIVE_POPOUT,u as ACTIVE_VIEW,x as Router,b as backPage,g as callback,T as getNotify,S as getParams,A as getRouter,j as hideNotify,w as nextPage,O as showNotify,k as swapApp};
