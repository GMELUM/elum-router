"use strict";var e=require("elum-state/react"),t=require("@vkontakte/vk-bridge"),r=require("react");const o=(e,t,r=[])=>{if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){if(e.constructor!==t.constructor)return!1;var a,s,p;if(Array.isArray(e)){if((a=e.length)!=t.length)return!1;for(s=a;0!=s--;)if(!o(e[s],t[s]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if((a=(p=Object.keys(e)).length)!==Object.keys(t).length)return!1;for(s=a;0!=s--;){var n=p[s];if(!r.includes(n)){if(!Object.prototype.hasOwnProperty.call(t,n))return!1;if(!o(e[n],t[n]))return!1}}return!0}return e!=e&&t!=t},a={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},s={},p=e.atom({key:"router_active_app"}),n=e.atom({key:"router_active_view"}),i=e.atom({key:"router_active_panel"}),u=e.atom({key:"router_active_modal"}),c=e.atom({key:"router_active_popout"}),l=e.atom({key:"router_active_notify"}),f=e.atom({key:"router_active_params"}),y=e.atom({key:"router_active_callback"}),m=["popout","modal","panel"],d=(r={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e.getter(p),a=e.getter(n),l=s[o][a],y=((e,t)=>{const r=typeof e;if("boolean"===r&&!e)return t.length-2;const o="boolean"===r?Boolean:String;for(let r=t.length-1;r>0;r--)if(o(t[r].stay)===e)return r;return 0})(r.toStay||!1,l);if(1===l.length)return void t.send("VKWebAppClose",{status:"success"});const m=l.at(-1);m&&m.freeze&&!r.ignoreFreeze||(s[o].__snapshot=[{view:a,...l[y]}],e.setter(p,o),e.setter(n,a),e.setter(i,l[y].panel),e.setter(u,l[y].modal),e.setter(c,l[y].popout),e.setter(f,l[y].params),l.splice(y+1))},v=(t,r)=>{s[t]||(s[t]={__snapshot:[Object.assign(a,r)]});const o=s[t].__snapshot[0];e.setter(p,t),e.setter(n,o.view||r.view),e.setter(i,o.panel||r.panel),e.setter(u,o.modal||r.modal),e.setter(c,o.popout||r.popout),e.setter(f,o.params||r.params)};const _={app:p,view:n,panel:i,modal:u,popout:c};exports.ACTIVE_APP=p,exports.ACTIVE_MODAL=u,exports.ACTIVE_NOTIFY=l,exports.ACTIVE_PANEL=i,exports.ACTIVE_PARAMS=f,exports.ACTIVE_POPOUT=c,exports.ACTIVE_VIEW=n,exports.Router=({app:t="web",branch:o,children:a})=>(e.getter(n)&&e.getter(p)||v(t||"app",{view:o}),r.useEffect((()=>{window.addEventListener("popstate",(()=>d())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),a),exports.backPage=d,exports.callback=t=>{const r=e.getter(y);r&&"function"==typeof r?r(t):console.warn("There is no function for callback")},exports.hideNotify=function(t){try{const r=e.getter(l);return(!t||r.type===t)&&(e.setter(l,void 0),r.callback({type:r.type,params:r.params}),!0)}catch{return!1}},exports.nextPage=(t,r)=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const l=e.getter(p),d=t.view||e.getter(n);s[l]||(s[l]={__snapshot:[]}),s[l][d]||(s[l][d]=[a]);const v=s[l][d].length,_=s[l][d][v-1],g={view:d,panel:t.panel||_.panel,modal:t.modal||_.modal,popout:t.popout||_.popout,stay:t.stay||a.stay,freeze:t.freeze||a.freeze,params:t.params||_.params,callback:r||void 0};for(let e of m){if(t[e])break;g[e]=a[e]}o(_,g)||s[l][d].push(g),s[l].__snapshot=[g],e.setter(p,l),e.setter(n,d),e.setter(i,g.panel),e.setter(u,g.modal),e.setter(c,g.popout),e.setter(f,g.params),e.setter(y,g.callback),t.clear&&d!=d&&(s[l].__snapshot=[a],s[l][d]=[a])},exports.showNotify=function(t,r,o,a){return a?function(t,r,o,a){const s=()=>(e.setter(l,void 0),a);e.setter(l,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}(t,r,o,a):function(t,r,o){return new Promise((a=>{const s=()=>(e.setter(l,void 0),a);e.setter(l,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}))}(t,r,o)},exports.swapApp=v,exports.useNotify=()=>{const t=e.useGlobalValue(l);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},exports.useParams=()=>{const[t]=r.useState(e.getter(f));return t},exports.useRouter=t=>{const o=r.useRef(e.getter(p)).current,a=e.useGlobalValue(_[t]),[s,n]=r.useState(a);return r.useEffect((()=>{"app"!==t&&e.getter(p)!==o||n(a)}),[a]),s};
