"use strict";var e=require("elum-state/react"),t=require("@vkontakte/vk-bridge"),r=require("react");const o=(e,t,r=[])=>{if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){if(e.constructor!==t.constructor)return!1;var a,s,p;if(Array.isArray(e)){if((a=e.length)!=t.length)return!1;for(s=a;0!=s--;)if(!o(e[s],t[s]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if((a=(p=Object.keys(e)).length)!==Object.keys(t).length)return!1;for(s=a;0!=s--;){var n=p[s];if(!r.includes(n)){if(!Object.prototype.hasOwnProperty.call(t,n))return!1;if(!o(e[n],t[n]))return!1}}return!0}return e!=e&&t!=t},a={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},s={},p=e.atom({key:"router_active_app"}),n=e.atom({key:"router_active_view"}),u=e.atom({key:"router_active_panel"}),i=e.atom({key:"router_active_modal"}),l=e.atom({key:"router_active_popout"}),c=e.atom({key:"router_active_notify"}),f=e.atom({key:"router_active_params"}),y=["popout","modal","panel"],m=(r={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e.getter(p),a=e.getter(n),c=s[o][a],y=((e,t)=>{const r=typeof e;if("boolean"===r&&!e)return t.length-2;const o="boolean"===r?Boolean:String;for(let r=t.length-1;r>0;r--)if(o(t[r].stay)===e)return r;return 0})(r.toStay||!1,c);if(1===c.length)return void t.send("VKWebAppClose",{status:"success"});const m=c.at(-1);m&&m.freeze&&!r.ignoreFreeze||(s[o].__snapshot=[{view:a,...c[y]}],e.setter(p,o),e.setter(n,a),e.setter(u,c[y].panel),e.setter(i,c[y].modal),e.setter(l,c[y].popout),e.setter(f,c[y].params),c.splice(y+1))},d=(t,r)=>{s[t]||(s[t]={__snapshot:[Object.assign(a,r)]});const o=s[t].__snapshot[0];e.setter(p,t),e.setter(n,o.view||r.view),e.setter(u,o.panel||r.panel),e.setter(i,o.modal||r.modal),e.setter(l,o.popout||r.popout),e.setter(f,o.params||r.params)};const v={app:p,view:n,panel:u,modal:i,popout:l};exports.ACTIVE_APP=p,exports.ACTIVE_MODAL=i,exports.ACTIVE_NOTIFY=c,exports.ACTIVE_PANEL=u,exports.ACTIVE_PARAMS=f,exports.ACTIVE_POPOUT=l,exports.ACTIVE_VIEW=n,exports.Router=({app:t="web",branch:o,children:a})=>(e.getter(n)&&e.getter(p)||d(t||"app",{view:o}),r.useEffect((()=>{window.addEventListener("popstate",(()=>m())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),a),exports.backPage=m,exports.hideNotify=function(t){try{const r=e.getter(c);return(!t||r.type===t)&&(e.setter(c,void 0),r.callback({type:r.type,params:r.params}),!0)}catch{return!1}},exports.nextPage=t=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const r=e.getter(p),c=t.view||e.getter(n);s[r]||(s[r]={__snapshot:[]}),s[r][c]||(s[r][c]=[a]);const m=s[r][c].length,d=s[r][c][m-1],v={view:c,panel:t.panel||d.panel,modal:t.modal||d.modal,popout:t.popout||d.popout,stay:t.stay||a.stay,freeze:t.freeze||a.freeze,params:t.params||d.params};for(let e of y){if(t[e])break;v[e]=a[e]}o(d,v)||s[r][c].push(v),s[r].__snapshot=[v],e.setter(p,r),e.setter(n,c),e.setter(u,v.panel),e.setter(i,v.modal),e.setter(l,v.popout),e.setter(f,v.params),t.clear&&c!=c&&(s[r].__snapshot=[a],s[r][c]=[a])},exports.showNotify=function(t,r,o,a){return a?function(t,r,o,a){const s=()=>(e.setter(c,void 0),a);e.setter(c,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}(t,r,o,a):function(t,r,o){return new Promise((a=>{const s=()=>(e.setter(c,void 0),a);e.setter(c,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}))}(t,r,o)},exports.swapApp=d,exports.useNotify=()=>{const t=e.useGlobalValue(c);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},exports.useParams=()=>{const[t]=r.useState(e.getter(f));return t},exports.useRouter=t=>{const o=r.useRef(e.getter(p)).current,a=e.useGlobalValue(v[t]),[s,n]=r.useState(a);return r.useEffect((()=>{"app"!==t&&e.getter(p)!==o||n(a)}),[a]),s};
