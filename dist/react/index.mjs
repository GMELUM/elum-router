import{atom as t,getter as e,setter as o,useGlobalValue as r}from"elum-state/react";import a from"@vkontakte/vk-bridge";import{useState as n,useRef as p,useEffect as s}from"react";const i=(t,e,o=[])=>{if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e){if(t.constructor!==e.constructor)return!1;var r,a,n;if(Array.isArray(t)){if((r=t.length)!=e.length)return!1;for(a=r;0!=a--;)if(!i(t[a],e[a]))return!1;return!0}if(t.constructor===RegExp)return t.source===e.source&&t.flags===e.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===e.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===e.toString();if((r=(n=Object.keys(t)).length)!==Object.keys(e).length)return!1;for(a=r;0!=a--;){var p=n[a];if(!o.includes(p)){if(!Object.prototype.hasOwnProperty.call(e,p))return!1;if(!i(t[p],e[p]))return!1}}return!0}return t!=t&&e!=e},l={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},u={},c=t({key:"router_active_app"}),f=t({key:"router_active_view"}),y=t({key:"router_active_panel"}),m=t({key:"router_active_modal"}),d=t({key:"router_active_popout"}),v=t({key:"router_active_notify"}),_=t({key:"router_active_params"}),h=["popout","modal","panel"],w=t=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const r=e(c),a=t.view||e(f);u[r]||(u[r]={__snapshot:[]}),u[r][a]||(u[r][a]=[l]);const n=u[r][a].length,p=u[r][a][n-1],s={view:a,panel:t.panel||p.panel,modal:t.modal||p.modal,popout:t.popout||p.popout,stay:t.stay||l.stay,freeze:t.freeze||l.freeze,params:t.params||p.params};for(let e of h){if(t[e])break;s[e]=l[e]}i(p,s)||u[r][a].push(s),u[r].__snapshot=[s],o(c,r),o(f,a),o(y,s.panel),o(m,s.modal),o(d,s.popout),o(_,s.params),t.clear&&a!=a&&(u[r].__snapshot=[l],u[r][a]=[l])},g=(t={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const r=e(c),n=e(f),p=u[r][n],s=((t,e)=>{const o=typeof t;if("boolean"===o&&!t)return e.length-2;const r="boolean"===o?Boolean:String;for(let o=e.length-1;o>0;o--)if(r(e[o].stay)===t)return o;return 0})(t.toStay||!1,p);if(1===p.length)return void a.send("VKWebAppClose",{status:"success"});const i=p.at(-1);i&&i.freeze&&!t.ignoreFreeze||(u[r].__snapshot=[{view:n,...p[s]}],o(c,r),o(f,n),o(y,p[s].panel),o(m,p[s].modal),o(d,p[s].popout),o(_,p[s].params),p.splice(s+1))},b=(t,e)=>{u[t]||(u[t]={__snapshot:[Object.assign(l,e)]});const r=u[t].__snapshot[0];o(c,t),o(f,r.view||e.view),o(y,r.panel||e.panel),o(m,r.modal||e.modal),o(d,r.popout||e.popout),o(_,r.params||e.params)};function k(t,e,r,a){return a?function(t,e,r,a){const n=()=>(o(v,void 0),a);o(v,{type:t,params:r,callback:n}),e&&setTimeout((()=>{n()({type:t,params:r})}),e)}(t,e,r,a):function(t,e,r){return new Promise((a=>{const n=()=>(o(v,void 0),a);o(v,{type:t,params:r,callback:n}),e&&setTimeout((()=>{n()({type:t,params:r})}),e)}))}(t,e,r)}function O(t){try{const r=e(v);return(!t||r.type===t)&&(o(v,void 0),r.callback({type:r.type,params:r.params}),!0)}catch{return!1}}const S=()=>{const[t]=n(e(_));return t},j={app:c,view:f,panel:y,modal:m,popout:d},z=t=>{const o=p(e(c)).current,a=r(j[t]),[i,l]=n(a);return s((()=>{"app"!==t&&e(c)!==o||l(a)}),[a]),i},A=()=>{const t=r(v);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},x=({app:t="web",branch:o,children:r})=>(e(f)&&e(c)||b(t||"app",{view:o}),s((()=>{window.addEventListener("popstate",(()=>g())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),r);export{c as ACTIVE_APP,m as ACTIVE_MODAL,v as ACTIVE_NOTIFY,y as ACTIVE_PANEL,_ as ACTIVE_PARAMS,d as ACTIVE_POPOUT,f as ACTIVE_VIEW,x as Router,g as backPage,O as hideNotify,w as nextPage,k as showNotify,b as swapApp,A as useNotify,S as useParams,z as useRouter};
