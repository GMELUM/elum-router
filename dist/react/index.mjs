import{atom as t,getter as e,setter as o,useGlobalValue as r}from"elum-state/react";import a from"@vkontakte/vk-bridge";import{useState as n,useRef as p,useEffect as s}from"react";const i=(t,e,o=[])=>{if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e){if(t.constructor!==e.constructor)return!1;var r,a,n;if(Array.isArray(t)){if((r=t.length)!=e.length)return!1;for(a=r;0!=a--;)if(!i(t[a],e[a]))return!1;return!0}if(t.constructor===RegExp)return t.source===e.source&&t.flags===e.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===e.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===e.toString();if((r=(n=Object.keys(t)).length)!==Object.keys(e).length)return!1;for(a=r;0!=a--;){var p=n[a];if(!o.includes(p)){if(!Object.prototype.hasOwnProperty.call(e,p))return!1;if(!i(t[p],e[p]))return!1}}return!0}return t!=t&&e!=e},c={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},l={},u=t({key:"router_active_app"}),f=t({key:"router_active_view"}),y=t({key:"router_active_panel"}),m=t({key:"router_active_modal"}),d=t({key:"router_active_popout"}),v=t({key:"router_active_notify"}),_=t({key:"router_active_params"}),h=t({key:"router_active_callback"}),w=["popout","modal","panel"],b=(t,r)=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=e(u),n=t.view||e(f);l[a]||(l[a]={__snapshot:[]}),l[a][n]||(l[a][n]=[c]);const p=l[a][n].length,s=l[a][n][p-1],v={view:n,panel:t.panel||s.panel,modal:t.modal||s.modal,popout:t.popout||s.popout,stay:t.stay||c.stay,freeze:t.freeze||c.freeze,params:t.params||s.params,callback:r||void 0};for(let e of w){if(t[e])break;v[e]=c[e]}i(s,v)||l[a][n].push(v),l[a].__snapshot=[v],o(u,a),o(f,n),o(y,v.panel),o(m,v.modal),o(d,v.popout),o(_,v.params),o(h,v.callback),t.clear&&n!=n&&(l[a].__snapshot=[c],l[a][n]=[c])},k=(t={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const r=e(u),n=e(f),p=l[r][n],s=((t,e)=>{const o=typeof t;if("boolean"===o&&!t)return e.length-2;const r="boolean"===o?Boolean:String;for(let o=e.length-1;o>0;o--)if(r(e[o].stay)===t)return o;return 0})(t.toStay||!1,p);if(1===p.length)return void a.send("VKWebAppClose",{status:"success"});const i=p.at(-1);i&&i.freeze&&!t.ignoreFreeze||(l[r].__snapshot=[{view:n,...p[s]}],o(u,r),o(f,n),o(y,p[s].panel),o(m,p[s].modal),o(d,p[s].popout),o(_,p[s].params),p.splice(s+1))},g=(t,e)=>{l[t]||(l[t]={__snapshot:[Object.assign(c,e)]});const r=l[t].__snapshot[0];o(u,t),o(f,r.view||e.view),o(y,r.panel||e.panel),o(m,r.modal||e.modal),o(d,r.popout||e.popout),o(_,r.params||e.params)},O=t=>{const o=e(h);o&&"function"==typeof o?o(t):console.warn("There is no function for callback")};function S(t,e,r,a){return a?function(t,e,r,a){const n=()=>(o(v,void 0),a);o(v,{type:t,params:r,callback:n}),e&&setTimeout((()=>{n()({type:t,params:r})}),e)}(t,e,r,a):function(t,e,r){return new Promise((a=>{const n=()=>(o(v,void 0),a);o(v,{type:t,params:r,callback:n}),e&&setTimeout((()=>{n()({type:t,params:r})}),e)}))}(t,e,r)}function j(t){try{const r=e(v);return(!t||r.type===t)&&(o(v,void 0),r.callback({type:r.type,params:r.params}),!0)}catch{return!1}}const z=()=>{const[t]=n(e(_));return t},A={app:u,view:f,panel:y,modal:m,popout:d},T=t=>{const o=p(e(u)).current,a=r(A[t]),[i,c]=n(a);return s((()=>{"app"!==t&&e(u)!==o||c(a)}),[a]),i},x=()=>{const t=r(v);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},E=({app:t="web",branch:o,children:r})=>(e(f)&&e(u)||g(t||"app",{view:o}),s((()=>{window.addEventListener("popstate",(()=>k())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),r);export{u as ACTIVE_APP,m as ACTIVE_MODAL,v as ACTIVE_NOTIFY,y as ACTIVE_PANEL,_ as ACTIVE_PARAMS,d as ACTIVE_POPOUT,f as ACTIVE_VIEW,E as Router,k as backPage,O as callback,j as hideNotify,b as nextPage,S as showNotify,g as swapApp,x as useNotify,z as useParams,T as useRouter};
